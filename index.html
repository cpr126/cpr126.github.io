<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNO Extractor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#6366f1',
                        'dark-bg': '#1f2937',
                        'light-bg': '#374151',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Ensures the background covers the whole page */
        body {
            background-color: #1f2937;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #374151;
        }
    </style>
</head>
<body>

    <div class="w-full max-w-6xl bg-light-bg p-8 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-extrabold text-white text-center border-b border-secondary pb-4">
            Uni Dispatch Helper by Peter C. 
        </h1>
        <p class="text-gray-300 text-center">
            Paste your raw manifest data below. TNOs are identified by prefixes:
            <strong class="text-secondary">UUS, 4C, MI, XDL, 2025, 2026, UNIH, GV, ONE, or U9</strong>.
        </p>

        <!-- Input Area (Section 1) -->
        <div>
            <label for="input-text" class="block text-sm font-medium text-gray-200 mb-2">1. Paste Your MANIFEST Data Here:</label>
            <textarea
                id="input-text"
                rows="10"
                class="w-full p-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-secondary focus:border-secondary transition duration-150 ease-in-out resize-none"
                placeholder="Paste your lines of data here..."
                oninput="processAllOutputs()"
            ></textarea>
        </div>

        <!-- Output Grid (Sections 2, 3, 4) -->
        <div class="grid md:grid-cols-3 gap-6 pt-4">

            <!-- 2. All Extracted TNOs -->
            <div class="col-span-3 md:col-span-1">
                <label for="output-all-tno" class="block text-sm font-medium text-gray-200 mb-2">2. All Extracted TNOs</label>
                <textarea id="output-all-tno" rows="8" readonly class="w-full p-3 bg-gray-800 text-yellow-300 font-mono rounded-lg border border-gray-700 resize-none cursor-default" placeholder="All unique TNOs."></textarea>
                <button onclick="copyOutput('output-all-tno')" id="copy-all-button" class="w-full mt-2 py-2 px-3 bg-primary text-white font-semibold rounded-lg hover:bg-secondary transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Copy All TNO (0)
                </button>
            </div>

            <!-- 3. Packages with Problems -->
            <div class="col-span-3 md:col-span-1">
                <label for="output-problem-tno" class="block text-sm font-medium text-gray-200 mb-2">3. Packages with Problems</label>
                <textarea id="output-problem-tno" rows="8" readonly class="w-full p-3 bg-gray-800 text-red-400 font-mono rounded-lg border border-gray-700 resize-none cursor-default" placeholder="TNOs matching problem criteria."></textarea>
                <button onclick="copyOutput('output-problem-tno')" id="copy-problem-button" class="w-full mt-2 py-2 px-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Copy Problem packages TNO (0)
                </button>
            </div>

            <!-- 4. UPS Packages (MI) with Notes -->
            <div class="col-span-3 md:col-span-1">
                <label for="output-mi-tno" class="block text-sm font-medium text-gray-200 mb-2">4. UPS Packages (MI) with route info </label>
                <textarea id="output-mi-tno" rows="8" readonly class="w-full p-3 bg-gray-800 text-green-300 font-mono rounded-lg border border-gray-700 resize-none cursor-default" placeholder="MI TNOs with appended [CODE] from notes."></textarea>
                <button onclick="copyOutput('output-mi-tno')" id="copy-mi-button" class="w-full mt-2 py-2 px-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Copy MI Packages TNO (0)
                </button>
            </div>
        </div>
        
        <!-- Scanning Tracker (Section 5) -->
        <div class="pt-6 border-t border-gray-700 grid md:grid-cols-2 gap-6">
            
            <!-- COLUMN 1: Scan Input & Scanned Problems -->
            <div>
                <!-- 5a. Scan Input -->
                <label for="scan-input" class="block text-sm font-medium text-gray-200 mb-2">5a. Scan TNO Here (One per line):</label>
                <textarea
                    id="scan-input"
                    rows="4"
                    class="w-full p-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-secondary focus:border-secondary transition duration-150 ease-in-out resize-none"
                    placeholder="TNOs entered by scanner..."
                    oninput="trackScans()"
                ></textarea>

                <!-- 5c. Scanned Problems Output (NEW) -->
                <div class="mt-4">
                    <label for="output-scanned-problem-tno" class="block text-sm font-medium text-gray-200 mb-2">5c. Scanned Problem Packages:</label>
                    <textarea 
                        id="output-scanned-problem-tno" 
                        rows="4" 
                        readonly 
                        class="w-full p-3 bg-gray-800 text-red-400 font-mono rounded-lg border border-gray-700 resize-none cursor-default" 
                        placeholder="Problem TNOs that have been scanned."
                    ></textarea>
                    <button onclick="copyOutput('output-scanned-problem-tno')" id="copy-scanned-problem-button" class="w-full mt-2 py-2 px-3 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-800 transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        Copy Scanned Problem Packages TNO (0)
                    </button>
                </div>
            </div>

            <!-- COLUMN 2: Remaining Output -->
            <div>
                <!-- 5b. Remaining Output -->
                <label for="output-remaining-tno" class="block text-sm font-medium text-gray-200 mb-2">5b. Remaining Unscanned Packages:</label>
                <textarea 
                    id="output-remaining-tno" 
                    rows="11" 
                    readonly 
                    class="w-full p-4 bg-gray-800 text-lg text-green-500 font-mono rounded-lg border border-gray-700 resize-none cursor-default" 
                    placeholder="Paste manifest data above to begin tracking..."
                >Paste manifest data above to begin tracking...</textarea>
                <button onclick="copyOutput('output-remaining-tno')" id="copy-remaining-button" class="w-full mt-2 py-2 px-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    Copy Remaining TNO (0)
                </button>
            </div>
        </div>


        <!-- Message Box for Copy Confirmation -->
        <div id="message-box" class="hidden fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300" role="alert">
            Copied to clipboard!
        </div>
    </div>

    <script>
        // --- Global State ---
        let fullManifestTNOs = new Set();
        let problemTNOsSet = new Set();

        // --- Regex Definitions ---
        const TNO_REGEX = /(UUS|4C|MI|XDL|2025|2026|UNIH|GV|ONE|U9)\w+/;
        const TNO_GLOBAL_REGEX = new RegExp(TNO_REGEX.source, 'g'); 

        const PROBLEM_DRIVER_REGEX = /Driver ID: (270995|270994|270991|270999|270997)/;
        // Includes 203, 230, and 213
        const PROBLEM_STATE_REGEX = /State: (230|213|203)/; 
        const SCAN_COUNTS_REGEX = /Scan Counts: (\d+)/;
        const MI_BRACKET_REGEX = /ã€(.*?)ã€‘/;

        // --- UI Element References ---
        const inputEl = document.getElementById('input-text');
        const scanInputEl = document.getElementById('scan-input');
        
        const outputAllEl = document.getElementById('output-all-tno');
        const copyAllBtn = document.getElementById('copy-all-button');
        
        const outputProblemEl = document.getElementById('output-problem-tno');
        const copyProblemBtn = document.getElementById('copy-problem-button');
        
        const outputMiEl = document.getElementById('output-mi-tno');
        const copyMiBtn = document.getElementById('copy-mi-button');

        // NEW OUTPUTS
        const outputScannedProblemEl = document.getElementById('output-scanned-problem-tno');
        const copyScannedProblemBtn = document.getElementById('copy-scanned-problem-button');
        
        const outputRemainingEl = document.getElementById('output-remaining-tno');
        const copyRemainingBtn = document.getElementById('copy-remaining-button');
        
        const messageBox = document.getElementById('message-box');

        /**
         * Segments the raw input text into blocks, where each block starts with a TNO.
         * Returns an array of objects: [{ tno: "...", data: "..." }, ...]
         */
        function segmentInput(rawText) {
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const blocks = [];
            let currentBlock = null;

            for (const line of lines) {
                const tnoMatch = line.match(TNO_REGEX);

                if (tnoMatch) {
                    // Start of a new package block
                    const tno = tnoMatch[0];
                    if (currentBlock) {
                        blocks.push(currentBlock);
                    }
                    // Start new block with the line containing the TNO
                    currentBlock = { tno: tno, data: line + '\n' }; 
                } else if (currentBlock) {
                    // Continuation of the current package block data
                    currentBlock.data += line + '\n';
                }
            }

            // Push the final block
            if (currentBlock) {
                blocks.push(currentBlock);
            }

            return blocks;
        }

        /**
         * Processes the manifest input, evaluates the rules, updates all extraction output fields (2, 3, 4),
         * and updates the global TNO lists used for tracking.
         */
        function processAllOutputs() {
            const rawText = inputEl.value;
            const blocks = segmentInput(rawText);

            // Reset global state
            fullManifestTNOs.clear();
            problemTNOsSet.clear();
            
            const miPackages = [];
            const allTNOsArray = [];
            const problemTNOsArray = [];


            blocks.forEach(block => {
                const { tno, data } = block;
                fullManifestTNOs.add(tno);
                allTNOsArray.push(tno);

                let isProblem = false;

                // --- 1. Check for Problems ---
                
                // Driver ID or State match
                if (data.match(PROBLEM_DRIVER_REGEX) || data.match(PROBLEM_STATE_REGEX)) {
                    isProblem = true;
                }
                
                // Scan Counts >= 4 check
                const scanMatch = data.match(SCAN_COUNTS_REGEX);
                if (scanMatch) {
                    const scanCount = parseInt(scanMatch[1], 10);
                    if (scanCount >= 4) {
                        isProblem = true;
                    }
                }
                
                if (isProblem) {
                    problemTNOsSet.add(tno);
                    problemTNOsArray.push(tno);
                }

                // --- 2. Check for MI Packages ---
                if (tno.startsWith('MI')) {
                    const bracketMatch = data.match(MI_BRACKET_REGEX);
                    let outputLine = tno;
                    
                    if (bracketMatch && bracketMatch[1]) {
                        outputLine += ` ã€${bracketMatch[1].trim()}ã€‘`;
                    }
                    miPackages.push(outputLine);
                }
            });

            // Update All TNOs output (Section 2)
            const uniqueAllTNOs = [...new Set(allTNOsArray)].join('\n');
            outputAllEl.value = uniqueAllTNOs;
            updateButton(copyAllBtn, 'All', allTNOsArray.length, 'primary');

            // Update Problem TNOs output (Section 3)
            const uniqueProblemTNOs = [...problemTNOsSet].join('\n');
            outputProblemEl.value = uniqueProblemTNOs;
            updateButton(copyProblemBtn, 'Problem TNOs', problemTNOsSet.size, 'red-600');

            // Update MI Packages output (Section 4)
            const uniqueMiPackages = [...new Set(miPackages)].join('\n');
            outputMiEl.value = uniqueMiPackages;
            updateButton(copyMiBtn, 'MI Packages', miPackages.length, 'teal-600');
            
            // Trigger the scanner tracker update (Section 5)
            trackScans();
        }

        /**
         * Processes the scanned input, calculates remaining packages, and updates the output (Section 5).
         */
        function trackScans() {
            const scannedRaw = scanInputEl.value;
            // Extract unique TNOs from the scan input
            const scannedTNOs = new Set(
                scannedRaw.split('\n')
                    .map(line => line.trim())
                    .filter(tno => tno.length > 0)
            );

            const remainingTNOs = [];
            const scannedProblemTNOs = [];
            
            // Check if manifest data exists
            if (fullManifestTNOs.size === 0) {
                outputRemainingEl.value = 'Paste manifest data (Section 1) to begin tracking.';
                outputScannedProblemEl.value = '';
                updateButton(copyRemainingBtn, 'Remaining TNOs', 0, 'green-600');
                updateButton(copyScannedProblemBtn, 'Scanned Problem TNOs', 0, 'red-700');
                return;
            }

            fullManifestTNOs.forEach(tno => {
                const isProblem = problemTNOsSet.has(tno);
                const isScanned = scannedTNOs.has(tno);

                if (!isScanned) {
                    // 5b. Unscanned Packages (Remaining)
                    if (isProblem) {
                        // Highlight problem packages with an emoji
                        remainingTNOs.push(`ðŸš¨ ${tno}`);
                    } else {
                        remainingTNOs.push(tno);
                    }
                } else if (isScanned && isProblem) {
                    // 5c. Scanned Problem Packages
                    scannedProblemTNOs.push(tno);
                }
            });

            // --- Update 5b (Remaining) ---
            if (remainingTNOs.length === 0) {
                outputRemainingEl.value = 'â€” ALL CLEAR â€”';
                outputRemainingEl.classList.remove('text-yellow-300');
                outputRemainingEl.classList.add('text-green-500');
            } else {
                outputRemainingEl.value = remainingTNOs.join('\n');
                outputRemainingEl.classList.add('text-yellow-300');
                outputRemainingEl.classList.remove('text-green-500');
            }
            updateButton(copyRemainingBtn, 'Remaining TNOs', remainingTNOs.length, 'green-600');
            
            // --- Update 5c (Scanned Problems) ---
            outputScannedProblemEl.value = scannedProblemTNOs.join('\n');
            updateButton(copyScannedProblemBtn, 'Scanned Problem TNOs', scannedProblemTNOs.length, 'red-700');
        }


        /**
         * Helper function to update button text and state.
         */
        function updateButton(button, name, count, color) {
            button.disabled = count === 0;
            button.textContent = `Copy ${name} (${count})`;
            
            // Re-apply hover color classes (Tailwind utility classes are dynamically generated)
            const allColors = ['bg-primary', 'hover:bg-secondary', 'bg-red-600', 'hover:bg-red-700', 'bg-red-700', 'hover:bg-red-800', 'bg-teal-600', 'hover:bg-teal-700', 'bg-green-600', 'hover:bg-green-700'];
            
            button.classList.remove(...allColors);

            if (color === 'red-600') {
                 button.classList.add('bg-red-600', 'hover:bg-red-700');
            } else if (color === 'red-700') {
                 button.classList.add('bg-red-700', 'hover:bg-red-800');
            } else if (color === 'teal-600') {
                 button.classList.add('bg-teal-600', 'hover:bg-teal-700');
            } else if (color === 'green-600') {
                 button.classList.add('bg-green-600', 'hover:bg-green-700');
            } else { // primary
                 button.classList.add('bg-primary', 'hover:bg-secondary');
            }
        }

        /**
         * Copies the content of the specified output box to the user's clipboard.
         */
        function copyOutput(elementId) {
            const element = document.getElementById(elementId);
            const content = element.value;
            if (!content || content.includes('ALL CLEAR')) return; // Prevent copying the ALL CLEAR message

            // When copying the remaining list, remove the emoji prefix
            let contentToCopy = content;
            if (elementId === 'output-remaining-tno') {
                contentToCopy = content.split('\n').map(line => line.replace('ðŸš¨ ', '')).join('\n');
            }

            if (navigator.clipboard) {
                navigator.clipboard.writeText(contentToCopy).then(() => {
                    showMessage('Copied to clipboard!');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    fallbackCopy(contentToCopy);
                });
            } else {
                fallbackCopy(contentToCopy);
            }
        }
        
        /**
         * Fallback mechanism for copying text.
         */
        function fallbackCopy(text) {
             const tempInput = document.createElement('textarea');
             tempInput.value = text;
             document.body.appendChild(tempInput);
             tempInput.select();
             try {
                document.execCommand('copy');
                showMessage('Copied to clipboard (Fallback)!');
             } catch (err) {
                console.error('Fallback copy failed', err);
                showMessage('Failed to copy. Please copy manually.');
             }
             document.body.removeChild(tempInput);
        }

        /**
         * Shows a temporary success message box.
         */
        function showMessage(msg) {
            messageBox.textContent = msg;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 1500);

            setTimeout(() => {
                 messageBox.classList.add('hidden');
                 messageBox.classList.remove('opacity-0');
            }, 1800);
        }

        // Initialize on load to ensure the button starts disabled
        window.onload = processAllOutputs;
    </script>
</body>
</html>
